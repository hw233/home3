package com.home.commonBase.data.role;
import com.home.commonBase.constlist.generate.BaseDataType;
import com.home.commonBase.data.scene.base.BuffData;
import com.home.commonBase.data.scene.base.CDData;
import com.home.shine.bytes.BytesReadStream;
import com.home.shine.bytes.BytesWriteStream;
import com.home.shine.data.BaseData;
import com.home.shine.support.DataWriter;
import com.home.shine.support.collection.IntIntMap;
import com.home.shine.support.collection.IntObjectMap;
import com.home.shine.support.pool.DataPool;

/** 主单位缓存数据(generated by shine) */
public class MUnitCacheData extends BaseData
{
	/** 数据类型ID */
	public static final int dataID=BaseDataType.MUnitCache;
	
	/** 当前属性组 */
	public IntIntMap currentAttributes;
	
	/** 保存buff组 */
	public IntObjectMap<BuffData> buffs;
	
	/** 缓存的时刻 */
	public long cacheTime;
	
	/** 保存CD组 */
	public IntObjectMap<CDData> cds;
	
	public MUnitCacheData()
	{
		_dataID=BaseDataType.MUnitCache;
	}
	
	/** 获取数据类名 */
	@Override
	public String getDataClassName()
	{
		return "MUnitCacheData";
	}
	
	/** 读取字节流(完整版) */
	@Override
	protected void toReadBytesFull(BytesReadStream stream)
	{
		stream.startReadObj();
		
		int currentAttributesLen=stream.readLen();
		if(this.currentAttributes!=null)
		{
			this.currentAttributes.clear();
			this.currentAttributes.ensureCapacity(currentAttributesLen);
		}
		else
		{
			this.currentAttributes=new IntIntMap(currentAttributesLen);
		}
		
		IntIntMap currentAttributesT=this.currentAttributes;
		for(int currentAttributesI=currentAttributesLen-1;currentAttributesI>=0;--currentAttributesI)
		{
			int currentAttributesK;
			int currentAttributesV;
			currentAttributesK=stream.readInt();
			
			currentAttributesV=stream.readInt();
			
			currentAttributesT.put(currentAttributesK,currentAttributesV);
		}
		
		int buffsLen=stream.readLen();
		if(this.buffs!=null)
		{
			this.buffs.clear();
			this.buffs.ensureCapacity(buffsLen);
		}
		else
		{
			this.buffs=new IntObjectMap<BuffData>(BuffData[]::new,buffsLen);
		}
		
		IntObjectMap<BuffData> buffsT=this.buffs;
		for(int buffsI=buffsLen-1;buffsI>=0;--buffsI)
		{
			BuffData buffsV;
			BaseData buffsVT=stream.readDataFullNotNull();
			if(buffsVT!=null)
			{
				if(buffsVT instanceof BuffData)
				{
					buffsV=(BuffData)buffsVT;
				}
				else
				{
					buffsV=new BuffData();
					if(!(buffsVT.getClass().isAssignableFrom(BuffData.class)))
					{
						stream.throwTypeReadError(BuffData.class,buffsVT.getClass());
					}
					buffsV.shadowCopy(buffsVT);
				}
			}
			else
			{
				buffsV=null;
			}
			
			buffsT.put(buffsV.instanceID,buffsV);
		}
		
		int cdsLen=stream.readLen();
		if(this.cds!=null)
		{
			this.cds.clear();
			this.cds.ensureCapacity(cdsLen);
		}
		else
		{
			this.cds=new IntObjectMap<CDData>(CDData[]::new,cdsLen);
		}
		
		IntObjectMap<CDData> cdsT=this.cds;
		for(int cdsI=cdsLen-1;cdsI>=0;--cdsI)
		{
			CDData cdsV;
			cdsV=new CDData();
			cdsV.readBytesFull(stream);
			
			cdsT.put(cdsV.id,cdsV);
		}
		
		this.cacheTime=stream.readLong();
		
		stream.endReadObj();
	}
	
	/** 写入字节流(完整版) */
	@Override
	protected void toWriteBytesFull(BytesWriteStream stream)
	{
		stream.startWriteObj();
		
		if(this.currentAttributes!=null)
		{
			stream.writeLen(this.currentAttributes.size());
			if(!this.currentAttributes.isEmpty())
			{
				int currentAttributesKFreeValue=this.currentAttributes.getFreeValue();
				int[] currentAttributesKTable=this.currentAttributes.getTable();
				for(int currentAttributesKI=currentAttributesKTable.length-2;currentAttributesKI>=0;currentAttributesKI-=2)
				{
					if(currentAttributesKTable[currentAttributesKI]!=currentAttributesKFreeValue)
					{
						int currentAttributesK=currentAttributesKTable[currentAttributesKI];
						int currentAttributesV=currentAttributesKTable[currentAttributesKI+1];
						stream.writeInt(currentAttributesK);
						
						stream.writeInt(currentAttributesV);
						
					}
				}
			}
		}
		else
		{
			nullObjError("currentAttributes");
		}
		
		if(this.buffs!=null)
		{
			stream.writeLen(this.buffs.size());
			if(!this.buffs.isEmpty())
			{
				Object[] buffsVValues=this.buffs.getValues();
				for(int buffsVI=buffsVValues.length-1;buffsVI>=0;--buffsVI)
				{
					if(buffsVValues[buffsVI]!=null)
					{
						BuffData buffsV=(BuffData)buffsVValues[buffsVI];
						if(buffsV!=null)
						{
							stream.writeDataFullNotNull(buffsV);
						}
						else
						{
							nullObjError("buffsV");
						}
						
					}
				}
			}
		}
		else
		{
			nullObjError("buffs");
		}
		
		if(this.cds!=null)
		{
			stream.writeLen(this.cds.size());
			if(!this.cds.isEmpty())
			{
				Object[] cdsVValues=this.cds.getValues();
				for(int cdsVI=cdsVValues.length-1;cdsVI>=0;--cdsVI)
				{
					if(cdsVValues[cdsVI]!=null)
					{
						CDData cdsV=(CDData)cdsVValues[cdsVI];
						if(cdsV!=null)
						{
							cdsV.writeBytesFull(stream);
						}
						else
						{
							nullObjError("cdsV");
						}
						
					}
				}
			}
		}
		else
		{
			nullObjError("cds");
		}
		
		stream.writeLong(this.cacheTime);
		
		stream.endWriteObj();
	}
	
	/** 读取字节流(简版) */
	@Override
	protected void toReadBytesSimple(BytesReadStream stream)
	{
		int currentAttributesLen=stream.readLen();
		if(this.currentAttributes!=null)
		{
			this.currentAttributes.clear();
			this.currentAttributes.ensureCapacity(currentAttributesLen);
		}
		else
		{
			this.currentAttributes=new IntIntMap(currentAttributesLen);
		}
		
		IntIntMap currentAttributesT=this.currentAttributes;
		for(int currentAttributesI=currentAttributesLen-1;currentAttributesI>=0;--currentAttributesI)
		{
			int currentAttributesK;
			int currentAttributesV;
			currentAttributesK=stream.readInt();
			
			currentAttributesV=stream.readInt();
			
			currentAttributesT.put(currentAttributesK,currentAttributesV);
		}
		
		int buffsLen=stream.readLen();
		if(this.buffs!=null)
		{
			this.buffs.clear();
			this.buffs.ensureCapacity(buffsLen);
		}
		else
		{
			this.buffs=new IntObjectMap<BuffData>(BuffData[]::new,buffsLen);
		}
		
		IntObjectMap<BuffData> buffsT=this.buffs;
		for(int buffsI=buffsLen-1;buffsI>=0;--buffsI)
		{
			BuffData buffsV;
			buffsV=(BuffData)stream.readDataSimpleNotNull();
			
			buffsT.put(buffsV.instanceID,buffsV);
		}
		
		int cdsLen=stream.readLen();
		if(this.cds!=null)
		{
			this.cds.clear();
			this.cds.ensureCapacity(cdsLen);
		}
		else
		{
			this.cds=new IntObjectMap<CDData>(CDData[]::new,cdsLen);
		}
		
		IntObjectMap<CDData> cdsT=this.cds;
		for(int cdsI=cdsLen-1;cdsI>=0;--cdsI)
		{
			CDData cdsV;
			cdsV=new CDData();
			cdsV.readBytesSimple(stream);
			
			cdsT.put(cdsV.id,cdsV);
		}
		
		this.cacheTime=stream.readLong();
		
	}
	
	/** 写入字节流(简版) */
	@Override
	protected void toWriteBytesSimple(BytesWriteStream stream)
	{
		if(this.currentAttributes!=null)
		{
			stream.writeLen(this.currentAttributes.size());
			if(!this.currentAttributes.isEmpty())
			{
				int currentAttributesKFreeValue=this.currentAttributes.getFreeValue();
				int[] currentAttributesKTable=this.currentAttributes.getTable();
				for(int currentAttributesKI=currentAttributesKTable.length-2;currentAttributesKI>=0;currentAttributesKI-=2)
				{
					if(currentAttributesKTable[currentAttributesKI]!=currentAttributesKFreeValue)
					{
						int currentAttributesK=currentAttributesKTable[currentAttributesKI];
						int currentAttributesV=currentAttributesKTable[currentAttributesKI+1];
						stream.writeInt(currentAttributesK);
						
						stream.writeInt(currentAttributesV);
						
					}
				}
			}
		}
		else
		{
			nullObjError("currentAttributes");
		}
		
		if(this.buffs!=null)
		{
			stream.writeLen(this.buffs.size());
			if(!this.buffs.isEmpty())
			{
				Object[] buffsVValues=this.buffs.getValues();
				for(int buffsVI=buffsVValues.length-1;buffsVI>=0;--buffsVI)
				{
					if(buffsVValues[buffsVI]!=null)
					{
						BuffData buffsV=(BuffData)buffsVValues[buffsVI];
						if(buffsV!=null)
						{
							stream.writeDataSimpleNotNull(buffsV);
						}
						else
						{
							nullObjError("buffsV");
						}
						
					}
				}
			}
		}
		else
		{
			nullObjError("buffs");
		}
		
		if(this.cds!=null)
		{
			stream.writeLen(this.cds.size());
			if(!this.cds.isEmpty())
			{
				Object[] cdsVValues=this.cds.getValues();
				for(int cdsVI=cdsVValues.length-1;cdsVI>=0;--cdsVI)
				{
					if(cdsVValues[cdsVI]!=null)
					{
						CDData cdsV=(CDData)cdsVValues[cdsVI];
						if(cdsV!=null)
						{
							cdsV.writeBytesSimple(stream);
						}
						else
						{
							nullObjError("cdsV");
						}
						
					}
				}
			}
		}
		else
		{
			nullObjError("cds");
		}
		
		stream.writeLong(this.cacheTime);
		
	}
	
	/** 复制(潜拷贝) */
	@Override
	protected void toShadowCopy(BaseData data)
	{
		if(!(data instanceof MUnitCacheData))
			return;
		
		MUnitCacheData mData=(MUnitCacheData)data;
		
		this.currentAttributes=mData.currentAttributes;
		this.buffs=mData.buffs;
		this.cds=mData.cds;
		this.cacheTime=mData.cacheTime;
	}
	
	/** 复制(深拷贝) */
	@Override
	protected void toCopy(BaseData data)
	{
		if(!(data instanceof MUnitCacheData))
			return;
		
		MUnitCacheData mData=(MUnitCacheData)data;
		
		if(mData.currentAttributes!=null)
		{
			if(this.currentAttributes!=null)
			{
				this.currentAttributes.clear();
				this.currentAttributes.ensureCapacity(mData.currentAttributes.size());
			}
			else
			{
				this.currentAttributes=new IntIntMap(mData.currentAttributes.size());
			}
			
			IntIntMap currentAttributesT=this.currentAttributes;
			if(!mData.currentAttributes.isEmpty())
			{
				int currentAttributesKFreeValue=mData.currentAttributes.getFreeValue();
				int[] currentAttributesKTable=mData.currentAttributes.getTable();
				for(int currentAttributesKI=currentAttributesKTable.length-2;currentAttributesKI>=0;currentAttributesKI-=2)
				{
					if(currentAttributesKTable[currentAttributesKI]!=currentAttributesKFreeValue)
					{
						int currentAttributesK=currentAttributesKTable[currentAttributesKI];
						int currentAttributesV=currentAttributesKTable[currentAttributesKI+1];
						int currentAttributesW;
						int currentAttributesU;
						currentAttributesW=currentAttributesK;
						
						currentAttributesU=currentAttributesV;
						
						currentAttributesT.put(currentAttributesW,currentAttributesU);
					}
				}
			}
		}
		else
		{
			this.currentAttributes=null;
			nullObjError("currentAttributes");
		}
		
		if(mData.buffs!=null)
		{
			if(this.buffs!=null)
			{
				this.buffs.clear();
				this.buffs.ensureCapacity(mData.buffs.size());
			}
			else
			{
				this.buffs=new IntObjectMap<BuffData>(BuffData[]::new,mData.buffs.size());
			}
			
			IntObjectMap<BuffData> buffsT=this.buffs;
			if(!mData.buffs.isEmpty())
			{
				Object[] buffsVValues=mData.buffs.getValues();
				for(int buffsVI=buffsVValues.length-1;buffsVI>=0;--buffsVI)
				{
					if(buffsVValues[buffsVI]!=null)
					{
						BuffData buffsV=(BuffData)buffsVValues[buffsVI];
						BuffData buffsU;
						if(buffsV!=null)
						{
							buffsU=(BuffData)buffsV.clone();
						}
						else
						{
							buffsU=null;
							nullObjError("buffsU");
						}
						
						buffsT.put(buffsU.instanceID,buffsU);
					}
				}
			}
		}
		else
		{
			this.buffs=null;
			nullObjError("buffs");
		}
		
		if(mData.cds!=null)
		{
			if(this.cds!=null)
			{
				this.cds.clear();
				this.cds.ensureCapacity(mData.cds.size());
			}
			else
			{
				this.cds=new IntObjectMap<CDData>(CDData[]::new,mData.cds.size());
			}
			
			IntObjectMap<CDData> cdsT=this.cds;
			if(!mData.cds.isEmpty())
			{
				Object[] cdsVValues=mData.cds.getValues();
				for(int cdsVI=cdsVValues.length-1;cdsVI>=0;--cdsVI)
				{
					if(cdsVValues[cdsVI]!=null)
					{
						CDData cdsV=(CDData)cdsVValues[cdsVI];
						CDData cdsU;
						if(cdsV!=null)
						{
							cdsU=new CDData();
							cdsU.copy(cdsV);
						}
						else
						{
							cdsU=null;
							nullObjError("cdsU");
						}
						
						cdsT.put(cdsU.id,cdsU);
					}
				}
			}
		}
		else
		{
			this.cds=null;
			nullObjError("cds");
		}
		
		this.cacheTime=mData.cacheTime;
		
	}
	
	/** 是否数据一致 */
	@Override
	protected boolean toDataEquals(BaseData data)
	{
		MUnitCacheData mData=(MUnitCacheData)data;
		if(mData.currentAttributes!=null)
		{
			if(this.currentAttributes==null)
				return false;
			if(this.currentAttributes.size()!=mData.currentAttributes.size())
				return false;
			IntIntMap currentAttributesR=mData.currentAttributes;
			if(!this.currentAttributes.isEmpty())
			{
				int currentAttributesKFreeValue=this.currentAttributes.getFreeValue();
				int[] currentAttributesKTable=this.currentAttributes.getTable();
				for(int currentAttributesKI=currentAttributesKTable.length-2;currentAttributesKI>=0;currentAttributesKI-=2)
				{
					if(currentAttributesKTable[currentAttributesKI]!=currentAttributesKFreeValue)
					{
						int currentAttributesK=currentAttributesKTable[currentAttributesKI];
						int currentAttributesV=currentAttributesKTable[currentAttributesKI+1];
						int currentAttributesU=currentAttributesR.get(currentAttributesK);
						if(currentAttributesV!=currentAttributesU)
							return false;
						
					}
				}
			}
		}
		else
		{
			if(this.currentAttributes!=null)
				return false;
		}
		
		if(mData.buffs!=null)
		{
			if(this.buffs==null)
				return false;
			if(this.buffs.size()!=mData.buffs.size())
				return false;
			IntObjectMap<BuffData> buffsR=mData.buffs;
			if(!this.buffs.isEmpty())
			{
				int buffsKFreeValue=this.buffs.getFreeValue();
				int[] buffsKKeys=this.buffs.getKeys();
				Object[] buffsVValues=this.buffs.getValues();
				for(int buffsKI=buffsKKeys.length-1;buffsKI>=0;--buffsKI)
				{
					int buffsK=buffsKKeys[buffsKI];
					if(buffsK!=buffsKFreeValue)
					{
						BuffData buffsV=(BuffData)buffsVValues[buffsKI];
						BuffData buffsU=buffsR.get(buffsK);
						if(buffsU!=null)
						{
							if(buffsV==null)
								return false;
							if(!buffsV.dataEquals(buffsU))
								return false;
						}
						else
						{
							if(buffsV!=null)
								return false;
						}
						
					}
				}
			}
		}
		else
		{
			if(this.buffs!=null)
				return false;
		}
		
		if(mData.cds!=null)
		{
			if(this.cds==null)
				return false;
			if(this.cds.size()!=mData.cds.size())
				return false;
			IntObjectMap<CDData> cdsR=mData.cds;
			if(!this.cds.isEmpty())
			{
				int cdsKFreeValue=this.cds.getFreeValue();
				int[] cdsKKeys=this.cds.getKeys();
				Object[] cdsVValues=this.cds.getValues();
				for(int cdsKI=cdsKKeys.length-1;cdsKI>=0;--cdsKI)
				{
					int cdsK=cdsKKeys[cdsKI];
					if(cdsK!=cdsKFreeValue)
					{
						CDData cdsV=(CDData)cdsVValues[cdsKI];
						CDData cdsU=cdsR.get(cdsK);
						if(cdsU!=null)
						{
							if(cdsV==null)
								return false;
							if(!cdsV.dataEquals(cdsU))
								return false;
						}
						else
						{
							if(cdsV!=null)
								return false;
						}
						
					}
				}
			}
		}
		else
		{
			if(this.cds!=null)
				return false;
		}
		
		if(this.cacheTime!=mData.cacheTime)
			return false;
		
		return true;
	}
	
	/** 转文本输出 */
	@Override
	protected void toWriteDataString(DataWriter writer)
	{
		writer.writeTabs();
		writer.sb.append("currentAttributes");
		writer.sb.append(':');
		writer.sb.append("Map<int,int>");
		if(this.currentAttributes!=null)
		{
			writer.sb.append('(');
			writer.sb.append(this.currentAttributes.size());
			writer.sb.append(')');
			writer.writeEnter();
			writer.writeLeftBrace();
			if(!this.currentAttributes.isEmpty())
			{
				int currentAttributesKFreeValue=this.currentAttributes.getFreeValue();
				int[] currentAttributesKTable=this.currentAttributes.getTable();
				for(int currentAttributesKI=currentAttributesKTable.length-2;currentAttributesKI>=0;currentAttributesKI-=2)
				{
					if(currentAttributesKTable[currentAttributesKI]!=currentAttributesKFreeValue)
					{
						int currentAttributesK=currentAttributesKTable[currentAttributesKI];
						int currentAttributesV=currentAttributesKTable[currentAttributesKI+1];
						writer.writeTabs();
						writer.sb.append(currentAttributesK);
						
						writer.sb.append(':');
						writer.sb.append(currentAttributesV);
						
						writer.writeEnter();
					}
				}
			}
			writer.writeRightBrace();
		}
		else
		{
			writer.sb.append("=null");
		}
		
		writer.writeEnter();
		writer.writeTabs();
		writer.sb.append("buffs");
		writer.sb.append(':');
		writer.sb.append("Map<int,BuffData>");
		if(this.buffs!=null)
		{
			writer.sb.append('(');
			writer.sb.append(this.buffs.size());
			writer.sb.append(')');
			writer.writeEnter();
			writer.writeLeftBrace();
			if(!this.buffs.isEmpty())
			{
				int buffsKFreeValue=this.buffs.getFreeValue();
				int[] buffsKKeys=this.buffs.getKeys();
				Object[] buffsVValues=this.buffs.getValues();
				for(int buffsKI=buffsKKeys.length-1;buffsKI>=0;--buffsKI)
				{
					int buffsK=buffsKKeys[buffsKI];
					if(buffsK!=buffsKFreeValue)
					{
						BuffData buffsV=(BuffData)buffsVValues[buffsKI];
						writer.writeTabs();
						writer.sb.append(buffsK);
						
						writer.sb.append(':');
						if(buffsV!=null)
						{
							buffsV.writeDataString(writer);
						}
						else
						{
							writer.sb.append("BuffData=null");
						}
						
						writer.writeEnter();
					}
				}
			}
			writer.writeRightBrace();
		}
		else
		{
			writer.sb.append("=null");
		}
		
		writer.writeEnter();
		writer.writeTabs();
		writer.sb.append("cds");
		writer.sb.append(':');
		writer.sb.append("Map<int,CDData>");
		if(this.cds!=null)
		{
			writer.sb.append('(');
			writer.sb.append(this.cds.size());
			writer.sb.append(')');
			writer.writeEnter();
			writer.writeLeftBrace();
			if(!this.cds.isEmpty())
			{
				int cdsKFreeValue=this.cds.getFreeValue();
				int[] cdsKKeys=this.cds.getKeys();
				Object[] cdsVValues=this.cds.getValues();
				for(int cdsKI=cdsKKeys.length-1;cdsKI>=0;--cdsKI)
				{
					int cdsK=cdsKKeys[cdsKI];
					if(cdsK!=cdsKFreeValue)
					{
						CDData cdsV=(CDData)cdsVValues[cdsKI];
						writer.writeTabs();
						writer.sb.append(cdsK);
						
						writer.sb.append(':');
						if(cdsV!=null)
						{
							cdsV.writeDataString(writer);
						}
						else
						{
							writer.sb.append("CDData=null");
						}
						
						writer.writeEnter();
					}
				}
			}
			writer.writeRightBrace();
		}
		else
		{
			writer.sb.append("=null");
		}
		
		writer.writeEnter();
		writer.writeTabs();
		writer.sb.append("cacheTime");
		writer.sb.append(':');
		writer.sb.append(this.cacheTime);
		
		writer.writeEnter();
	}
	
	/** 初始化初值 */
	@Override
	public void initDefault()
	{
		this.currentAttributes=new IntIntMap();
		this.buffs=new IntObjectMap<BuffData>(BuffData[]::new);
		this.cds=new IntObjectMap<CDData>(CDData[]::new);
	}
	
	/** 回池 */
	@Override
	protected void toRelease(DataPool pool)
	{
		this.currentAttributes=null;
		this.buffs=null;
		this.cds=null;
		this.cacheTime=0L;
	}
	
}
