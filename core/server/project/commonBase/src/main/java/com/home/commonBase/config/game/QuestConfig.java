package com.home.commonBase.config.game;
import com.home.commonBase.config.base.BaseConfig;
import com.home.commonBase.config.game.LanguageConfig;
import com.home.commonBase.constlist.generate.QuestAcceptType;
import com.home.commonBase.constlist.generate.QuestRepeatType;
import com.home.shine.bytes.BytesReadStream;
import com.home.shine.bytes.BytesWriteStream;
import com.home.shine.ctrl.Ctrl;
import com.home.shine.data.DIntData;
import com.home.shine.dataEx.TimeExpression;
import com.home.shine.support.collection.IntList;
import com.home.shine.support.collection.IntObjectMap;
import com.home.shine.support.collection.SList;
import java.util.Comparator;

/** 任务表(generated by shine) */
public class QuestConfig extends BaseConfig
{
	/** 存储集合 */
	private static IntObjectMap<QuestConfig> _dic;
	
	/** 任务链字典 */
	public static IntObjectMap<SList<QuestConfig>> questLineDic;
	
	/** 初始化任务组 */
	public static IntList initQuests;
	
	/** id */
	public int id;
	
	/** 奖励id */
	public int rewardID;
	
	/** 提交npc */
	public int commitNPC;
	
	/** 任务目标组执行方式 */
	public int executeType;
	
	/** 提交方式 */
	public int commitType;
	
	/** 接取npc */
	public int acceptNPC;
	
	/** 任务链 */
	public DIntData questLine;
	
	/** 任务链比较序号 */
	public int questLineIndex=-1;
	
	/** 接取方式 */
	public int acceptType;
	
	/** 接取条件 */
	public int[][] acceptConditions;
	
	/** 前置任务组 */
	public int[] preQuests;
	
	/** 后置任务组 */
	public IntList afterQuests;
	
	/** 周期时间 */
	public String cycleTime="";
	
	/** 重复类型 */
	public int repeatType;
	
	/** 任务物品 */
	public DIntData[] questItem;
	
	/** 完成动作组 */
	public int[][] completeActions;
	
	/** 任务目标组 */
	public int[] tasks;
	
	/** 失败时间 */
	public String failTime="";
	
	/** 周期任务失败后是否不可接取(在时间周期内) */
	public boolean cantAcceptFailed;
	
	/** 是否可放弃 */
	public boolean canGiveUp;
	
	/** 是否关键任务 */
	public boolean isKeyQuest;
	
	/** 是否已废弃 */
	public boolean isDeprecated;
	
	/** 类型 */
	public int type;
	
	/** 名字 */
	public String name="";
	
	/** 名字原值 */
	private String _name;
	
	/** 周期时间(时间表达式) */
	public TimeExpression cycleTimeT;
	
	/** 失败时间(时间表达式) */
	public TimeExpression failTimeT;
	
	/** 获取 */
	public static QuestConfig get(int id)
	{
		return _dic.get(id);
	}
	
	/** 设置字典 */
	public static void setDic(IntObjectMap<QuestConfig> dic)
	{
		_dic=dic;
	}
	
	/** 获取全部 */
	public static IntObjectMap<QuestConfig> getDic()
	{
		return _dic;
	}
	
	/** 读取字节流(简版) */
	@Override
	protected void toReadBytesSimple(BytesReadStream stream)
	{
		super.toReadBytesSimple(stream);
		
		this.id=stream.readInt();
		
		this.name=stream.readUTF();
		
		this.type=stream.readInt();
		
		int tasksLen=stream.readLen();
		if(this.tasks==null || this.tasks.length!=tasksLen)
		{
			this.tasks=new int[tasksLen];
		}
		int[] tasksT=this.tasks;
		for(int tasksI=0;tasksI<tasksLen;++tasksI)
		{
			int tasksV;
			tasksV=stream.readInt();
			
			tasksT[tasksI]=tasksV;
		}
		
		this.executeType=stream.readInt();
		
		this.repeatType=stream.readInt();
		
		this.questLine=new DIntData();
		this.questLine.readBytesSimple(stream);
		
		this.cycleTime=stream.readUTF();
		
		int preQuestsLen=stream.readLen();
		if(this.preQuests==null || this.preQuests.length!=preQuestsLen)
		{
			this.preQuests=new int[preQuestsLen];
		}
		int[] preQuestsT=this.preQuests;
		for(int preQuestsI=0;preQuestsI<preQuestsLen;++preQuestsI)
		{
			int preQuestsV;
			preQuestsV=stream.readInt();
			
			preQuestsT[preQuestsI]=preQuestsV;
		}
		
		int acceptConditionsLen=stream.readLen();
		if(this.acceptConditions==null || this.acceptConditions.length!=acceptConditionsLen)
		{
			this.acceptConditions=new int[acceptConditionsLen][];
		}
		int[][] acceptConditionsT=this.acceptConditions;
		for(int acceptConditionsI=0;acceptConditionsI<acceptConditionsLen;++acceptConditionsI)
		{
			int[] acceptConditionsV;
			int acceptConditionsVLen=stream.readLen();
			acceptConditionsV=new int[acceptConditionsVLen];
			int[] acceptConditionsVT=acceptConditionsV;
			for(int acceptConditionsVI=0;acceptConditionsVI<acceptConditionsVLen;++acceptConditionsVI)
			{
				int acceptConditionsVV;
				acceptConditionsVV=stream.readInt();
				
				acceptConditionsVT[acceptConditionsVI]=acceptConditionsVV;
			}
			
			acceptConditionsT[acceptConditionsI]=acceptConditionsV;
		}
		
		this.acceptType=stream.readInt();
		
		this.acceptNPC=stream.readInt();
		
		this.commitType=stream.readInt();
		
		this.commitNPC=stream.readInt();
		
		int questItemLen=stream.readLen();
		if(this.questItem==null || this.questItem.length!=questItemLen)
		{
			this.questItem=new DIntData[questItemLen];
		}
		DIntData[] questItemT=this.questItem;
		for(int questItemI=0;questItemI<questItemLen;++questItemI)
		{
			DIntData questItemV;
			questItemV=new DIntData();
			questItemV.readBytesSimple(stream);
			
			questItemT[questItemI]=questItemV;
		}
		
		int completeActionsLen=stream.readLen();
		if(this.completeActions==null || this.completeActions.length!=completeActionsLen)
		{
			this.completeActions=new int[completeActionsLen][];
		}
		int[][] completeActionsT=this.completeActions;
		for(int completeActionsI=0;completeActionsI<completeActionsLen;++completeActionsI)
		{
			int[] completeActionsV;
			int completeActionsVLen=stream.readLen();
			completeActionsV=new int[completeActionsVLen];
			int[] completeActionsVT=completeActionsV;
			for(int completeActionsVI=0;completeActionsVI<completeActionsVLen;++completeActionsVI)
			{
				int completeActionsVV;
				completeActionsVV=stream.readInt();
				
				completeActionsVT[completeActionsVI]=completeActionsVV;
			}
			
			completeActionsT[completeActionsI]=completeActionsV;
		}
		
		this.failTime=stream.readUTF();
		
		this.canGiveUp=stream.readBoolean();
		
		this.cantAcceptFailed=stream.readBoolean();
		
		this.rewardID=stream.readInt();
		
		this.isDeprecated=stream.readBoolean();
		
		this.isKeyQuest=stream.readBoolean();
		
	}
	
	/** 读完表后处理 */
	@Override
	protected void afterReadConfig()
	{
		super.afterReadConfig();
		
		afterQuests=new IntList();
	}
	
	/** 读完所有表后处理 */
	public static void afterReadConfigAll()
	{
		if(_dic==null)
			return;
		
		initQuests=new IntList();
		questLineDic=new IntObjectMap<>(SList[]::new);
		
		QuestConfig[] values;
		QuestConfig v;
		QuestConfig v2;
		
		for(int i=(values=_dic.getValues()).length-1;i>=0;--i)
		{
			if((v=values[i])!=null)
			{
				//可主动接
				if(v.acceptType!=QuestAcceptType.Passive)
				{
					if(v.preQuests.length>0)
					{
						for(int v3:v.preQuests)
						{
							//只能以单次任务作为前置
							if((v2=_dic.get(v3)).repeatType!=QuestRepeatType.Once)
							{
								Ctrl.throwError("只能以单次任务作为前置");
								return;
							}
							
							v2.afterQuests.add(v.id);
						}
					}
					else
					{
						//满足自动接取
						if(v.acceptType==QuestAcceptType.Auto)
						{
							initQuests.add(v.id);
						}
					}
				}
				
				if(!v.questLine.isEmpty())
				{
					SList<QuestConfig> list=questLineDic.computeIfAbsent(v.questLine.key,k->new SList<>(QuestConfig[]::new));
					list.add(v);
				}
			}
		}
		
		Comparator<QuestConfig> comparator=QuestConfig::sortQuestLine;
		
		SList<QuestConfig>[] values1;
		SList<QuestConfig> v1;
		
		for(int i1=(values1=questLineDic.getValues()).length-1;i1>=0;--i1)
		{
			if((v1=values1[i1])!=null)
			{
				v1.sort(comparator);
				
				QuestConfig[] values3=v1.getValues();
				QuestConfig v3;
				
				for(int i3=0,len3=v1.size();i3<len3;++i3)
				{
					//现算序号
					values3[i3].questLineIndex=i3;
				}
			}
		}
	}
	
	/** 生成刷新配置 */
	@Override
	protected void generateRefresh()
	{
		if(_name==null)
			_name=name;
		name=LanguageConfig.getText(_name);
		
		cycleTimeT=new TimeExpression(cycleTime);
		
		failTimeT=new TimeExpression(failTime);
		
	}
	
	/** 写入字节流(简版) */
	@Override
	protected void toWriteBytesSimple(BytesWriteStream stream)
	{
		super.toWriteBytesSimple(stream);
		
		stream.writeInt(this.id);
		
		stream.writeUTF(this.name);
		
		stream.writeInt(this.type);
		
		if(this.tasks!=null)
		{
			int[] tasksT=this.tasks;
			stream.writeLen(tasksT.length);
			for(int tasksVI=0,tasksVLen=tasksT.length;tasksVI<tasksVLen;++tasksVI)
			{
				int tasksV=tasksT[tasksVI];
				stream.writeInt(tasksV);
				
			}
		}
		else
		{
			nullObjError("tasks");
		}
		
		stream.writeInt(this.executeType);
		
		stream.writeInt(this.repeatType);
		
		if(this.questLine!=null)
		{
			this.questLine.writeBytesSimple(stream);
		}
		else
		{
			nullObjError("questLine");
		}
		
		stream.writeUTF(this.cycleTime);
		
		if(this.preQuests!=null)
		{
			int[] preQuestsT=this.preQuests;
			stream.writeLen(preQuestsT.length);
			for(int preQuestsVI=0,preQuestsVLen=preQuestsT.length;preQuestsVI<preQuestsVLen;++preQuestsVI)
			{
				int preQuestsV=preQuestsT[preQuestsVI];
				stream.writeInt(preQuestsV);
				
			}
		}
		else
		{
			nullObjError("preQuests");
		}
		
		if(this.acceptConditions!=null)
		{
			int[][] acceptConditionsT=this.acceptConditions;
			stream.writeLen(acceptConditionsT.length);
			for(int acceptConditionsVI=0,acceptConditionsVLen=acceptConditionsT.length;acceptConditionsVI<acceptConditionsVLen;++acceptConditionsVI)
			{
				int[] acceptConditionsV=acceptConditionsT[acceptConditionsVI];
				if(acceptConditionsV!=null)
				{
					int[] acceptConditionsVT=acceptConditionsV;
					stream.writeLen(acceptConditionsVT.length);
					for(int acceptConditionsVVI=0,acceptConditionsVVLen=acceptConditionsVT.length;acceptConditionsVVI<acceptConditionsVVLen;++acceptConditionsVVI)
					{
						int acceptConditionsVV=acceptConditionsVT[acceptConditionsVVI];
						stream.writeInt(acceptConditionsVV);
						
					}
				}
				else
				{
					nullObjError("acceptConditionsV");
				}
				
			}
		}
		else
		{
			nullObjError("acceptConditions");
		}
		
		stream.writeInt(this.acceptType);
		
		stream.writeInt(this.acceptNPC);
		
		stream.writeInt(this.commitType);
		
		stream.writeInt(this.commitNPC);
		
		if(this.questItem!=null)
		{
			DIntData[] questItemT=this.questItem;
			stream.writeLen(questItemT.length);
			for(int questItemVI=0,questItemVLen=questItemT.length;questItemVI<questItemVLen;++questItemVI)
			{
				DIntData questItemV=questItemT[questItemVI];
				if(questItemV!=null)
				{
					questItemV.writeBytesSimple(stream);
				}
				else
				{
					nullObjError("questItemV");
				}
				
			}
		}
		else
		{
			nullObjError("questItem");
		}
		
		if(this.completeActions!=null)
		{
			int[][] completeActionsT=this.completeActions;
			stream.writeLen(completeActionsT.length);
			for(int completeActionsVI=0,completeActionsVLen=completeActionsT.length;completeActionsVI<completeActionsVLen;++completeActionsVI)
			{
				int[] completeActionsV=completeActionsT[completeActionsVI];
				if(completeActionsV!=null)
				{
					int[] completeActionsVT=completeActionsV;
					stream.writeLen(completeActionsVT.length);
					for(int completeActionsVVI=0,completeActionsVVLen=completeActionsVT.length;completeActionsVVI<completeActionsVVLen;++completeActionsVVI)
					{
						int completeActionsVV=completeActionsVT[completeActionsVVI];
						stream.writeInt(completeActionsVV);
						
					}
				}
				else
				{
					nullObjError("completeActionsV");
				}
				
			}
		}
		else
		{
			nullObjError("completeActions");
		}
		
		stream.writeUTF(this.failTime);
		
		stream.writeBoolean(this.canGiveUp);
		
		stream.writeBoolean(this.cantAcceptFailed);
		
		stream.writeInt(this.rewardID);
		
		stream.writeBoolean(this.isDeprecated);
		
		stream.writeBoolean(this.isKeyQuest);
		
	}
	
	private static int sortQuestLine(QuestConfig config0,QuestConfig config1)
	{
		return Integer.compare(config0.questLine.value,config1.questLine.value);
	}
	
}
