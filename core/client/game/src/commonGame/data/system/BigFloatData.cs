using ShineEngine;
using System;

/// <summary>
/// 大浮点数(generated by shine)
/// </summary>
public class BigFloatData:BaseData
{
	/// <summary>
	/// 数据类型ID
	/// </summary>
	public const int dataID=BaseDataType.BigFloat;
	
	/// <summary>
	/// 值
	/// </summary>
	public double value;
	
	/// <summary>
	/// 阶
	/// </summary>
	public int rank;
	
	/** 十进制字符串dirty */
	private bool _numberStrDirty=true;
	
	/** 十进制字符串 */
	private string _numberStr;
	
	private BigFloatData _tempData;
	
	public BigFloatData()
	{
		_dataID=BaseDataType.BigFloat;
	}
	
	/// <summary>
	/// 获取数据类名
	/// </summary>
	public override string getDataClassName()
	{
		return "BigFloatData";
	}
	
	/// <summary>
	/// 读取字节流(完整版)
	/// </summary>
	protected override void toReadBytesFull(BytesReadStream stream)
	{
		stream.startReadObj();
		
		this.rank=stream.readInt();
		
		this.value=stream.readDouble();
		
		stream.endReadObj();
	}
	
	/// <summary>
	/// 写入字节流(完整版)
	/// </summary>
	protected override void toWriteBytesFull(BytesWriteStream stream)
	{
		stream.startWriteObj();
		
		stream.writeInt(this.rank);
		
		stream.writeDouble(this.value);
		
		stream.endWriteObj();
	}
	
	/// <summary>
	/// 读取字节流(简版)
	/// </summary>
	protected override void toReadBytesSimple(BytesReadStream stream)
	{
		this.rank=stream.readInt();
		
		this.value=stream.readDouble();
		
	}
	
	/// <summary>
	/// 写入字节流(简版)
	/// </summary>
	protected override void toWriteBytesSimple(BytesWriteStream stream)
	{
		stream.writeInt(this.rank);
		
		stream.writeDouble(this.value);
		
	}
	
	/// <summary>
	/// 复制(潜拷贝)
	/// </summary>
	protected override void toShadowCopy(BaseData data)
	{
		if(!(data is BigFloatData))
			return;
		
		BigFloatData mData=(BigFloatData)data;
		
		this.rank=mData.rank;
		this.value=mData.value;
	}
	
	/// <summary>
	/// 复制(深拷贝)
	/// </summary>
	protected override void toCopy(BaseData data)
	{
		if(!(data is BigFloatData))
			return;
		
		BigFloatData mData=(BigFloatData)data;
		
		this.rank=mData.rank;
		
		this.value=mData.value;
		
	}
	
	/// <summary>
	/// 是否数据一致
	/// </summary>
	protected override bool toDataEquals(BaseData data)
	{
		BigFloatData mData=(BigFloatData)data;
		if(this.rank!=mData.rank)
			return false;
		
		if(this.value!=mData.value)
			return false;
		
		return true;
	}
	
	/// <summary>
	/// 转文本输出
	/// </summary>
	protected override void toWriteDataString(DataWriter writer)
	{
		writer.writeTabs();
		writer.sb.Append("rank");
		writer.sb.Append(':');
		writer.sb.Append(this.rank);
		
		writer.writeEnter();
		writer.writeTabs();
		writer.sb.Append("value");
		writer.sb.Append(':');
		writer.sb.Append(this.value);
		
		writer.writeEnter();
	}
	
	/// <summary>
	/// 初始化初值
	/// </summary>
	public override void initDefault()
	{
		
	}
	
	private void setDirty()
	{
		_numberStrDirty=true;
	}
	
	/// <summary>
	/// 是否为空(零)
	/// </summary>
	public bool isEmpty()
	{
		return value==0f && rank==0;
	}
	
	/// <summary>
	/// 是否为负数
	/// </summary>
	public bool isNegative()
	{
		return value<0;
	}
	
	/// <summary>
	/// 是否为空(零)
	/// </summary>
	public void setEmpty()
	{
		value=0f;
		rank=0;
		setDirty();
	}
	
	public override string ToString()
	{
		return toNumberString();
	}
	
	/// <summary>
	/// 转化数字显示
	/// </summary>
	public string toNumberString()
	{
		if(_numberStrDirty)
		{
			_numberStrDirty=false;

			if(Global.bigFloatWei==0)
			{
				Ctrl.throwError("未初始化BigFloat配置");
			}

			if(rank==0)
			{
				_numberStr=StringUtils.floorStrD2(value);
			}
			else
			{
				_numberStr=StringUtils.floorStrD2(value)+BigFloatRankConfig.getRankStr(rank);
			}
		}

		return _numberStr;
	}
	
	/// <summary>
	/// 转化为double
	/// </summary>
	public double toFloat()
	{
		if(Global.bigFloatWeiValue==0.0)
		{
			Ctrl.throwError("未初始化BigFloat配置");
			return 0;
		}

		if(rank==0)
			return value;

		double re=value;

		while(rank<0)
		{
			re/=Global.bigFloatWeiValue;
			++rank;
		}

		while(rank>0)
		{
			re*=Global.bigFloatWeiValue;
			--rank;
		}

		return re;
	}
	
	/// <summary>
	/// 转化拼装long形
	/// </summary>
	public long toMixLong()
	{
		bool isN=value<0;

		double vv=isN ? -value : value;

		long re=(long)(vv*Global.bigFloatWeiLastValue);

		re|=((long)rank<<32);

		if(isN)
		{
			re=-re;
		}

		return re;
	}
	
	/// <summary>
	/// 刷新
	/// </summary>
	public void refresh()
	{
		if(Global.bigFloatWeiValue==0.0)
		{
			Ctrl.throwError("未初始化BigFloat配置");
			return;
		}
		
		if(value==0)
		{
			setEmpty();
			return;
		}

		if(value>0)
		{
			while(value>=Global.bigFloatWeiValue || rank<0)
			{
				value/=Global.bigFloatWeiValue;
				++rank;
			}

			while(value<1.0 && rank>0)
			{
				value*=Global.bigFloatWeiValue;
				--rank;
			}
		}
		else
		{
			while(value<=-Global.bigFloatWeiValue || rank<0)
			{
				value/=Global.bigFloatWeiValue;
				++rank;
			}

			while(value>-1.0 && rank>0)
			{
				value*=Global.bigFloatWeiValue;
				--rank;
			}
		}

		setDirty();
	}
	
	private static double changeRank(double value,int rankD)
	{
		if(rankD==0)
			return value;

		return value/Math.Pow(Global.bigFloatWeiValue,rankD);
	}
	
	/// <summary>
	/// 通过字符串初始化
	/// </summary>
	public void initByStr(string str)
	{
		if(str.isEmpty())
		{
			setEmpty();
			return;
		}

		int re=0;

		for(int i=str.Length-1;i>=0;--i)
		{
		    if(StringUtils.isCharIsNumber(str[i]))
			{
				re=i+1;
				break;
			}
		}

		//没有末尾
		if(re==str.Length)
		{
			rank=0;
			value=double.Parse(str);
		}
		else
		{
			rank=BigFloatRankConfig.getRankByStr(str.Substring(re));
			value=double.Parse(str.Substring(0,re));
		}

		refresh();
	}
	
	/// <summary>
	/// 通过字符串初始化
	/// </summary>
	public void initByDouble(double vv)
	{
		rank=0;
		value=vv;

		refresh();
	}
	
	/// <summary>
	/// 通过字符串初始化
	/// </summary>
	public void initByMixLong(long num)
	{
		bool isN=num<0;

		long vv=isN ? -num : num;

		rank=(int)(vv>>32);
		value=((int)vv)/Global.bigFloatWeiLastValue;

		if(isN)
		{
			value=-value;
		}
	}
	
	/// <summary>
	/// 通过字符串初始化
	/// </summary>
	public void initByRV(int rank,double vv)
	{
		this.rank=rank;
		this.value=vv;
		
		refresh();
	}
	
	/// <summary>
	/// 通过字符串创建
	/// </summary>
	public static BigFloatData createByStr(String str)
	{
		BigFloatData re=new BigFloatData();
		re.initByStr(str);
		return re;
	}
	
	/// <summary>
	/// 通过int创建
	/// </summary>
	public static BigFloatData createByDouble(double value)
	{
		BigFloatData re=new BigFloatData();
		re.initByDouble(value);
		return re;
	}
	
	/// <summary>
	/// 通过混合long创建
	/// </summary>
	public static BigFloatData createByMixLong(long value)
	{
		BigFloatData re=new BigFloatData();
		re.initByMixLong(value);
		return re;
	}
	
	/// <summary>
	/// 比大小(b1<b2返回-1),b1==b2返回0,b1>b2返回1
	/// </summary>
	public static int compare(BigFloatData b1,BigFloatData b2)
	{
		int i1=MathUtils.doubleCompare(b1.value,0);
		int i2=MathUtils.doubleCompare(b2.value,0);

		if(i1!=i2)
			return MathUtils.intCompare(i1,i2);

		if(i1==0)
			return 0;

		int rankRe=MathUtils.intCompare(b1.rank,b2.rank);

		if(rankRe!=0)
			return i1>0 ? rankRe : -rankRe;

		return MathUtils.doubleCompare(b1.value,b2.value);
	}
	
	/// <summary>
	/// 比大小(b1<b2返回-1),b1==b2返回0,b1>b2返回1
	/// </summary>
	public static int compare(BigFloatData b1,double value)
	{
		int i1=MathUtils.doubleCompare(b1.value,0);
		int i2=MathUtils.doubleCompare(value,0);

		if(i1!=i2)
			return MathUtils.intCompare(i1,i2);

		if(i1==0)
			return 0;

		if(Math.Abs(value)<Global.bigFloatWeiValue)
		{
			int rankRe=MathUtils.intCompare(b1.rank,0);

			if(rankRe!=0)
				return i1>0 ? rankRe : -rankRe;

			return MathUtils.doubleCompare(b1.value,value);
		}
		else
		{
			BigFloatData tempData=b1._tempData;

			if(tempData==null)
			{
				tempData=b1._tempData=new BigFloatData();
			}

			tempData.initByDouble(value);
			return compare(b1,tempData);
		}
	}
	
	/// <summary>
	/// 加法
	/// </summary>
	public void add(BigFloatData data)
	{
		if(this.rank==data.rank)
		{
			this.value+=data.value;
		}
		else
		{
			int dRank=this.rank-data.rank;

			//超出限制
			if(Math.Abs(dRank)>=Global.bigFloatRankMaxD)
				return;

			this.value+=changeRank(data.value,dRank);
		}

		refresh();
	}
	
	/// <summary>
	/// 加法(返回新对象)
	/// </summary>
	public BigFloatData addN(BigFloatData data)
	{
		BigFloatData re=this.clone();
		re.add(data);
		return re;
	}
	
	/// <summary>
	/// 加法
	/// </summary>
	public void add(double vv)
	{
		//超出限制
		if(Math.Abs(rank)>=Global.bigFloatRankMaxD)
			return;

		this.value+=changeRank(vv,rank);

		refresh();
	}
	
	/// <summary>
	/// 加法(返回新对象)
	/// </summary>
	public BigFloatData addN(double vv)
	{
		BigFloatData re=this.clone();
		re.add(vv);
		return re;
	}
	
	/// <summary>
	/// 减法
	/// </summary>
	public void sub(BigFloatData data)
	{
		if(this.rank==data.rank)
		{
			this.value-=data.value;
		}
		else
		{
			int dRank=this.rank-data.rank;

			//超出限制
			if(Math.Abs(dRank)>=Global.bigFloatRankMaxD)
				return;

			this.value-=changeRank(data.value,dRank);
		}

		refresh();
	}
	
	/// <summary>
	/// 减法(返回新对象)
	/// </summary>
	public BigFloatData subN(BigFloatData data)
	{
		BigFloatData re=this.clone();
		re.sub(data);
		return re;
	}
	
	/// <summary>
	/// 减法
	/// </summary>
	public void sub(double vv)
	{
		//超出限制
		if(Math.Abs(rank)>=Global.bigFloatRankMaxD)
			return;

		this.value-=changeRank(vv,rank);

		refresh();
	}
	
	/// <summary>
	/// 减法(返回新对象)
	/// </summary>
	public BigFloatData subN(double vv)
	{
		BigFloatData re=this.clone();
		re.sub(vv);
		return re;
	}
	
	/// <summary>
	/// 乘法
	/// </summary>
	public void mul(BigFloatData data)
	{
		this.value*=data.value;
		this.rank+=data.rank;

		refresh();
	}
	
	/// <summary>
	/// 乘法(返回新对象)
	/// </summary>
	public BigFloatData mulN(BigFloatData data)
	{
		BigFloatData re=this.clone();
		re.mul(data);
		return re;
	}
	
	/// <summary>
	/// 乘法
	/// </summary>
	public void mul(double vv)
	{
		this.value*=vv;

		refresh();
	}
	
	/// <summary>
	/// 乘法(返回新对象)
	/// </summary>
	public BigFloatData mulN(double vv)
	{
		BigFloatData re=this.clone();
		re.mul(vv);
		return re;
	}
	
	/// <summary>
	/// 除法
	/// </summary>
	public void div(BigFloatData data)
	{
		this.value/=data.value;
		this.rank-=data.rank;

		refresh();
	}
	
	/// <summary>
	/// 除法(返回值新new对象)
	/// </summary>
	public BigFloatData divN(BigFloatData data)
	{
		BigFloatData re=this.clone();
		re.div(data);
		return re;
	}
	
	/// <summary>
	/// 乘法
	/// </summary>
	public void div(double vv)
	{
		if(vv==0.0)
		{
			Ctrl.throwError("除数不能为0");
			return;
		}

		//超出限制
		this.value/=vv;

		refresh();
	}
	
	/// <summary>
	/// 除法(返回值新new对象)
	/// </summary>
	public BigFloatData divN(double vv)
	{
		BigFloatData re=this.clone();
		re.div(vv);
		return re;
	}
	
	/// <summary>
	/// 克隆数据
	/// </summary>
	public BigFloatData clone()
	{
		BigFloatData re = new BigFloatData();
		re.rank=this.rank;
		re.value=this.value;
		re._numberStrDirty=true;
		return re;
	}
	
	public override void clear()
	{
		setEmpty();
	}
	
	/// <summary>
	/// 回池
	/// </summary>
	protected override void toRelease(DataPool pool)
	{
		this.rank=0;
		this.value=0.0;
	}
	
}
